from langchain_google_genai import ChatGoogleGenerativeAI
from langchain.prompts import PromptTemplate
from langchain.chains import LLMChain
from langchain_groq import ChatGroq
import os
import re

# os.environ['GROQ_API_KEY'] = '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'
# llm = ChatGroq(name = "llama3-70b-8192")
# Google API key
os.environ["GOOGLE_API_KEY"] = "AIzaSyAZSP3AXxW8vmcalgAYmikudzSqT_IgWQk"

# Initialize LLM
llm = ChatGoogleGenerativeAI(model="gemini-pro")
def parse_code(code):
    pattern = re.compile(r"```(?:python)?(.*?)```", re.DOTALL)
    match = pattern.search(code)
    if match:
        return match.group(1).strip()
    else:
        return code.strip()
    

def extract(text):

    title_template = PromptTemplate(
            input_variables=['conversation'],
            template="""I want you to be an disease symptom analyzer and analyze the below said conversation between doctor and patient.
            {conversation}
            give me the current symptoms that the patient have in coma sperated values like this chest pain,vomit,stress,etc
            make sure to give me the names of the symptoms only
            stick to the said instructions and donot hallucinate
            """
        )

    title_chain = LLMChain(llm=llm, prompt=title_template, verbose=False, output_key='output')

    response = title_chain.invoke({'conversation': text})
    #print(response)
    
    lines = [line.strip('- ') for line in response["output"].split('\n')]

    # Join the lines with commas
    csv_output = ', '.join(lines)

    return csv_output

convo =""" Yeah. So you're a 26 year old, generally healthy and with sorry, back pain? Chest pain. Chest pain. Okay. When did the chest pain start? So I I guess I I don't know if I'd really call it pain. It's it's been just very uncomfortable. Like, it just felt a little odd for, like, a week and a half. Week and a half? It's kind of yeah. It's kind of, like, a very sharp strong pain, when I take a deep breath. Okay. But I don't notice it all the time. It's just it's often when I'm sitting and studying or, when I'm walking when I'm walking to school. Okay. Did you have any accidents or injuries around that time? No. Nothing that I can think of. Okay. Did it come on suddenly, or is it more gradual? Yeah. It's, no. It's it's pretty it's pretty well. It seems the same each time. It's kind of last, like, 20 minutes or so. And I've tried Tylenol, and I've tried Advil, and I've even tried, like, like, an Alka Seltzer, and it hasn't really helped very much. Okay. So it's pretty cons it's not consistent throughout the day. It only happens at certain times of the day? Yeah. It'll come on for, like, 20 minutes, like, here and there. Okay. Anything that you think triggers it? I don't I don't really know. I I was kind of worried. I I was kinda worried that it could be a heart thing. I I feel like it might it might be it it could be stress, but I'm I'm not really sure. And my dad had a a heart attack last year. He was pretty young. He's, like, in his fifties, and it it just kind of scares me because now he's having these heart problems. Okay. So these chest pains last for about 20 minutes. It only happens when you take a deep breath in. And after the 20 minutes, do they come and go? Is it something that gradually weans off, or is it fairly sharp? It seems like it kind of goes away once I once I'm at school and, like, talking to people and doing other things. It's kind of when I notice it when I'm on my walks, when I'm alone, or, like, when I'm studying alone more. Like, maybe I have it when I'm talking to other people, but I don't really notice it. Okay. Does it get worse with exercise? I don't think so. It just kinda like, when I'm walking to school, it kinda stays the same. I haven't done any strenuous exercise lately because I've just had so much, schoolwork piling up. So you mainly get it at so you can get it at rest, I should say. Exactly. Yeah. Like, when I'm studying. Okay. Any fevers, sick at all last little while? No. No. I don't think so. No? You've been feeling well otherwise? Yeah. Other I mean, besides just kind of feeling stressed, I, like, I I've been trying to quit smoking, and that's been that's been kind of hard. And school's just very, very, busy right now. When did you stop smoking? So, like, I guess I'm trying to quit. I'm smoking less than I used to. I probably smoke 5 cigarettes a day, but it used to be a little bit more. Okay. Coming back to the stress, is there anything recently that's causing you more worries? It's just that I'm I'm doing my master's of social work, and I'm getting towards the end. And it's just it's very scary because I'm working on my final, thesis, and there's just a lot involved. And it's it's just making me very nervous. Okay. Is there anything special about the last couple of weeks that's maybe more stressed than previously? I think just the the time crunch of having to to finish this. I've I've never felt, like, so, like, there is so little time to to do the work that I need to do. Got it. And have you ever felt this pain before? Anytime in your life? No. Not before this. Okay. So it comes on several times a day, not necessarily triggered by anything. You said you smoke. When did you start smoking? Like, when I was probably 18. I I sometimes smoked a little, and then I smoked a little more, maybe, like, 10 cigarettes a day for, like, the last 2 years, but then a few months ago, I've been I've been cutting it in half. Okay. Now when you get this chest this chest pain, do you ever feel short of breath? I I I think I I make myself nervous with it, and then I kind of start breathing faster, but I don't have a hard I don't have a hard time breathing otherwise. And it's hard to get a deep breath because I'm it makes me really nervous. Does your heart ever flutter? Feel like it's skipping a beat? No. Only if I only if I, like, if I if I'm having kind of an anxiety attack that felt like that before, but not any other time. Okay. Don't get any chest pain. Alright. And just in terms of other things, so anything else you've seen a doctor for in the past? You mentioned anxiety attacks. Yeah. Like, I talked to my family doctor about that when I was a teenager, but I really, haven't, you know, seen my doctor for it anytime in the last, like, 8 years or so. Anything else you've seen, miss Ann? Oh, sorry. No. Nothing else. I just I that I was kind of when I was in high school, I I had those, and then I really haven't for a long time. But, lately, I felt like this like, I I could maybe get them again. So you've never had asthma as a child? No. And you don't have asthma now? No. Okay. Do you take any medications right now? No. Like, I take, like, a multivitamin, but that's it. Okay. And you live in London? Mhmm. And do, like, for school. Got it. You lived during your master's in social work. Have anyone been around you've been sick at all last little while? No. Like, I live alone. I haven't really seen very many people lately. Okay. And how do you manage stress when you do get it? I I try to I try to, like, set some time aside just to read books that, like, I like to read instead of, like, school books at nighttime. And I do really enjoy running. It's I've been a little bit nervous to do it lately, but, usually, I run, like, a few times a week. Okay. And when you're pretty preoccupied, do you ever get the chest pain? Like, when I'm really when I'm work like, working with classmates or, like, thinking really like, if I'm talking to someone else, I don't really get it or if I if I'm, like, working on a task with my hand. But it's when I'm walking and I I'm alone kinda with my thoughts or when I'm studying, that's when I when I get it. Understood. And you said your father passed early from a heart attack. I'm sorry. But any else in your family, either your parents or mom, have any health issues? He's alive. Like, he had a heart attack. He just now he has to see a lot of heart doctors. No. There there's nothing else in my family like that. I I don't really know, like, about my grandpa, like, my dad's dad, but, like, he might have also. He just kind of he just passed away young from, like, an accident. So, yeah, I'm not really sure. Got it. So no one has died suddenly with no explanation when they were young or while they were swimming? No. No one's ever talked about arrhythmias, or is that a word familiar to you? No. No. It's just my dad and his heart attack. That's, like, the only thing I know of. Okay. Sounds good. I think I've got all the information I need, and I'll pass it on to the doctor who'll take a look at you. Okay. Have a good one. Okay. Thank you."""
convo2 = """What brings you in today? So I, so I have COPD, and it's usually, like, pretty manageable with my poppers and that. But, just in the last, like, 3 days, I feel like it's gotten a lot worse. You know, I I feel like I'm coughing more often and I'm now kind of producing more sputum. Kind of like a greeny, yellowy sputum. I even noticed that, there is, like, a little bit of blood a couple times when I was, like, really coughing hard. Mhmm. I think it's, like, harder to breathe than usual. I have home oxygen or anything. I'm not I didn't think I was quite there yet, but this, these last few days, it's been it's been really hard to breathe. Mhmm. I see. Okay. So all of this has happened in the past 3 days. Have your symptoms gotten better or worse over this time? I feel like they've been, get maybe maybe getting a little worse. They they definitely haven't gotten better. Mhmm. Okay. And has this ever happened to you before? I've had I've had some troubles, like, when I've been sick before where the cough has gotten pretty bad. This is probably this is probably the worst that I've had, but I have, like, I have had my COPD has been made worse by, being sick. I see. Okay. Well, I guess the first thing we're gonna so how's how bad is your shortness of breath? Like, I I walked here fine, but I normally, like, can walk around the block and I go for a walk, usually a couple times a day, to walk my dog. And it's been just it's been a little bit trickier to do that. I see. Okay. And, have you ever had, any hospitalizations in the past, specifically for, COPD exacerbations? I haven't, like, stayed over in the hospital. I've, like, come to emerge a couple of times. Mhmm. Okay. How many times? I think twice. Maybe over the last, like, 3 years. Okay. When were you diagnosed with COPD? 4 or 5 years ago. K. Was it formally diagnosed using, the proper testing? Yeah. They, referred me to, a lung a lung doctor. I see. Okay. And have you had any fevers or chills? Oh, I feel like I I may have had a fever last night. I felt really hot. Can you check your temperature? I'm I don't have a thermometer at home. Yeah. No problem. We can check your temperature here. Yeah. By the bed, I would say I had a fever. Sure. And, have you had any other symptoms? So have you had, like, a runny nose or stuffy, nose, knee pain in your sinuses? I think I think I've, I've had a bit of, like, I guess, pressure in the the science area, but it's been the the cough has been the thing that's been the most bothersome. Mhmm. I see. And have you had a sore throat at all? No. Oh, okay. A headache? Maybe a little bit. Yeah. Okay. And, any, nausea or vomiting? No. Any diarrhea or constipation? No. Abdominal pain? No. Okay. And have you recently lost weight unintentionally? No. No. I wish, but no. Okay. Have you had any night sweats where you feel like you're drenched in sweats at night? No. Nothing like that. Alright. And, have you had any exposures to anyone who could potentially be sick? Let me think. I, I meet my my, I meet a couple of friends to walk our dogs together outside. Mhmm. And one of them was a bit sick for a bit. We try not to get too close, but maybe I don't know. Maybe sometimes we walk a little too close. We feel too safe because we're, like, outside. Okay. Okay. And, did your friend get a COVID test done? I don't know. That's okay. Okay. And, you mentioned that you had COPD that was diagnosed 4 or 5 years ago. Any other medical conditions that you've been diagnosed with? Yeah. I have a high blood pressure. Okay. And are you taking any medications? I'm not. I'm not. We've talked about it, but I I decided to try to change my lifestyle as much as I could first. Sure. And I've also done that for the COPD. It's generally pretty like, I've been really trying to take care of it, but, I feel like I maybe got sick or something this time. Yeah. So my blood pressure is, like, okay right now. Okay. I've had high blood pressure, and then I lost weight and started this walking more. That's great. That's really, really good that you're taking better care of yourself. Should definitely continue doing that. I look like that. Right? Mhmm. Of course. Yeah. And you've mentioned that you have some buffers. How often do you use those? Oh, like, I have, the one that I use every day Mhmm. That I'm supposed to just use no matter what. And then the one that I use when, kinda just when I need it, I probably use it, like, once every 2 weeks. Okay. Okay. And you mentioned that your COPDs are getting better. Do you find that it's affecting your life in any way, affecting the way that you're doing your, daily activities at at home or, at work if you're working? I I'm, like, pretty okay except for, like, if I get sick. I see. Yeah. It's been I think it's, like, pretty well managed. Like, I stay on top of my lifestyle now. That's good. That's good. Yeah. Or maybe not. Mhmm. Do you have any allergies? No. No. Not no. No. No allergies to medications? No. Okay. Okay. Good. And do you, just a couple more to the, general questions. Have you traveled anywhere outside the province recently? No. Have you I guess I I should've asked you earlier, but have you noticed any change in your sense of smell? No. I don't think so. Any change in your sense of taste? No. I don't think so. Any confusion or fuzzy, feeling? No. No? Okay. Any, muscle aches in your body? No. Okay. Alright. And, just kinda some, questions about your living situation. Do you currently live alone? And I you mentioned that you have a dog. Are there any is there any any anyone else in the house? My husband. Okay. And, do you, currently work? Yeah. I, like, I've been working from home. I work for the municipality. I see. Do you think you might have had any exposures to say dust or smoke or anything like that that could worsen your symptoms? I don't think so. Okay. And, do you drink alcohol? Oh, very rarely. Okay. Do you smoke? I I used to. I quit once they said I had COPD. I smoked a half pack a day for probably 20 years. Okay. Okay. And do you consume marijuana or any recreational drugs? No. Okay. Alright. Well, I guess one more question. Are there any, lung diseases or heart conditions or cancers that run-in the family? No. Nothing that I can think of. Alright. Well, thank you. Those are all the questions I had for you. I will now do a physical exam and and look at your vitals, and listen to your, chest. It's likely that what you have right now is COPD exacerbation. Maybe just, like, an infection that you got, which, worsened some of your COPD symptoms. We would also have to rule out COVID, so we'll be doing a COVID swab. And, we'll decide based on the, on your labs and your vital signs. It's and and so the other things whether you need to stay in the ER and be admitted or if you are, good to go home. I will also talk to my attending and we'll make those decisions, together and come back and talk to you. Does that sound good to you? Yeah. That sounds great. Thank you. Welcome."""
def extract_symptoms(text):
    title_template = PromptTemplate(
            input_variables=['conversation'],
            template="""I want you to be an disease symptom analyzer and analyze the below said conversation between doctor and patient.
            {conversation}
            give me the current symptoms that the patient have in coma sperated values like this chest pain,vomit,stress,etc
            make sure to give me the names of the symptoms only
            stick to the said instructions and donot hallucinate
            """
        )

    title_chain = LLMChain(llm=llm, prompt=title_template, verbose=False, output_key='output')

    response = title_chain.invoke({'conversation': text})
    print(response)
    
    lines = [line.strip('- ') for line in response["output"].split('\n')]

    # Join the lines with commas
    csv_output = ', '.join(lines)

    return csv_output

#print(extract(convo2))